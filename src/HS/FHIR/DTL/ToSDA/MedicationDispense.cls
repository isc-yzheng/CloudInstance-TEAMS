Class HS.FHIR.DTL.ToSDA.MedicationDispense Extends Ens.DataTransformDTL [ DependsOn = (HS.FHIR.vDSTU2.Model.Resource.MedicationDispense, HS.SDA3.Medication) ]
{

Parameter IGNOREMISSINGSOURCE = 1;

Parameter REPORTERRORS = 1;

Parameter TREATEMPTYREPEATINGFIELDASNULL = 0;

XData DTL [ XMLNamespace = "http://www.intersystems.com/dtl" ]
{
<transform sourceClass='HS.FHIR.vDSTU2.Model.Resource.MedicationDispense' targetClass='HS.SDA3.Medication' create='existing' language='objectscript' >
<annotation>This transform uses the reserved DTL input parameter named &#39;aux&#39;.
For this transform, aux is a local array of strings.  The values held in aux were generated by the FHIR to SDA DTL framework prior to calling into this transform.
aux(&quot;EncounterNumbers&quot;, fhir_resource_id) = SDA EncounterNumber to use for the encounter pointed to by the FHIR resource.</annotation>
<assign value='##class(HS.FHIR.DTL.Utils).LookupFHIR("ToSDAMedicationDispenseStatus",source.status.value)' property='target.Status' action='set' />
<if condition='target.ExternalId = ""' >
<true>
<assign value='source.identifier.value.value' property='target.ExternalId' action='set' />
</true>
</if>

<if condition='$IsObject(source.medicationCodeableConcept)' >
<true>
<assign value='source.medicationCodeableConcept.text.value' property='target.DrugProduct.OriginalText' action='set' />
<if condition='source.medicationCodeableConcept.coding.(1) &apos;= ""' >
<true>
<assign value='source.medicationCodeableConcept.coding.(1).display.value' property='target.DrugProduct.Description' action='set' />
<assign value='source.medicationCodeableConcept.coding.(1).code.value' property='target.DrugProduct.Code' action='set' />
<assign value='source.medicationCodeableConcept.coding.(1).version.value' property='target.DrugProduct.CodeSystemVersionId' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).GetCodeForURI(source.medicationCodeableConcept.coding.(1).system.value)' property='target.DrugProduct.SDACodingStandard' action='set' />
</true>
</if>
<if condition='(target.OrderItem.Code = "") &amp;&amp; (target.OrderItem.Description = "") &amp;&amp; (target.OrderItem.OriginalText = "")' >
<true>
<assign value='source.medicationCodeableConcept.text.value' property='target.OrderItem.OriginalText' action='set' />
<if condition='source.medicationCodeableConcept.coding.(1) &apos;= ""' >
<true>
<assign value='source.medicationCodeableConcept.coding.(1).display.value' property='target.OrderItem.Description' action='set' />
<assign value='source.medicationCodeableConcept.coding.(1).code.value' property='target.OrderItem.Code' action='set' />
<assign value='source.medicationCodeableConcept.coding.(1).version.value' property='target.OrderItem.CodeSystemVersionId' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).GetCodeForURI(source.medicationCodeableConcept.coding.(1).system.value)' property='target.OrderItem.SDACodingStandard' action='set' />
</true>
</if>
</true>
</if>
</true>
<false>
<if condition='..StartsWith(source.medicationReference.reference.value,"#")' >
<true>
<foreach property='source.contained()' key='k2' >
<if condition=' ("#"_source.contained.(k2).Medication.id.value = source.medicationReference.reference.value)' >
<true>
<subtransform class='HS.FHIR.DTL.ToSDA.SubTransform.MedicationDrugProduct' targetObj='target' sourceObj='source.contained.(k2).Medication' />
</true>
</if>
</foreach>
</true>
</if>
</false>
</if>

<if condition='target.Comments = ""' >
<true>
<assign value='source.note.value' property='target.Comments' action='set' />
</true>
</if>
<if condition='source.dosageInstruction.Count() &gt; 0' >
<true>
<code>
<![CDATA[ do target.DosageSteps.Clear() ]]></code>
<foreach property='source.dosageInstruction()' key='k1' >
<assign value='source.dosageInstruction.(k1).text.value' property='target.DosageSteps.(k1).TextInstruction' action='set' />
<assign value='source.dosageInstruction.(k1).doseQuantity.value.value' property='target.DosageSteps.(k1).DoseQuantity' action='set' />
<assign value='source.dosageInstruction.(k1).doseQuantity.unit.value' property='target.DosageSteps.(k1).DoseUoM.Description' action='set' />
<assign value='source.dosageInstruction.(k1).doseQuantity.code.value' property='target.DosageSteps.(k1).DoseUoM.Code' action='set' />
<if condition='k1=1' >
<true>
<assign value='source.dosageInstruction.(k1).route.text.value' property='target.Route.OriginalText' action='set' />
<assign value='source.dosageInstruction.(k1).route.coding.(1).code.value' property='target.Route.Code' action='set' />
<assign value='source.dosageInstruction.(k1).route.coding.(1).display.value' property='target.Route.Description' action='set' />
<assign value='source.dosageInstruction.(k1).route.coding.(1).version.value' property='target.Route.CodeSystemVersionId' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).GetCodeForURI(source.dosageInstruction.(k1).route.coding.(1).system.value)' property='target.Route.SDACodingStandard' action='set' />
</true>
</if>
</foreach>
</true>
</if>

<if condition='$G(aux("FromMedicationOrder")) &apos;= 1' >
<true>
<code>
<![CDATA[ set iPrescription = 1]]></code>
<foreach property='source.authorizingPrescription()' key='k3' >
<if condition='..StartsWith(source.authorizingPrescription.(k3).reference.value,"#")' >
<true>
<foreach property='source.contained()' key='k4' >
<if condition='("#"_source.contained.(k4).MedicationOrder.id.value = source.authorizingPrescription.(k3).reference.value) &amp;&amp; (iPrescription = 1)' >
<true>
<if condition='..Piece(source.contained.(k4).MedicationOrder.encounter.reference.value,"Encounter/",2) &apos;= ""' >
<true>
<assign value='$G(aux("EncounterNumbers",..Piece(source.contained.(k4).MedicationOrder.encounter.reference.value,"Encounter/",2)))' property='target.EncounterNumber' action='set' />
</true>
</if>
<if condition='..StartsWith(source.contained.(k4).MedicationOrder.medicationReference.reference.value,"#")' >
<true>
<foreach property='source.contained()' key='k5' >
<if condition='("#"_source.contained.(k5).Medication.id.value = source.contained.(k4).MedicationOrder.medicationReference.reference.value)' >
<true>
<assign value='source.contained.(k5).Medication.product.form.text.value' property='target.DosageForm.OriginalText' action='set' />
<assign value='source.contained.(k5).Medication.product.form.coding.(1).display.value' property='target.DosageForm.Description' action='set' />
<assign value='source.contained.(k5).Medication.product.form.coding.(1).code.value' property='target.DosageForm.Code' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).GetCodeForURI(source.contained.(k5).Medication.product.form.coding.(1).system.value)' property='target.DosageForm.SDACodingStandard' action='set' />
<assign value='source.contained.(k5).Medication.product.form.coding.(1).version.value' property='target.DosageForm.CodeSystemVersionId' action='set' />
<assign value='source.contained.(k5).Medication.code.text.value' property='target.DrugProduct.OriginalText' action='set' />
<assign value='source.contained.(k5).Medication.code.coding.(1).display.value' property='target.DrugProduct.Description' action='set' />
<assign value='source.contained.(k5).Medication.code.coding.(1).code.value' property='target.DrugProduct.Code' action='set' />
<assign value='source.contained.(k5).Medication.code.coding.(1).version.value' property='target.DrugProduct.CodeSystemVersionId' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).GetCodeForURI(source.contained.(k5).Medication.code.coding.(1).system.value)' property='target.DrugProduct.SDACodingStandard' action='set' />
<if condition='(source.contained.(k5).Medication.isBrand.value &apos;= "") &amp;&amp; (source.contained.(k5).Medication.isBrand.value &apos;= 1)' >
<true>
<assign value='source.contained.(k5).Medication.code.coding.(1).display.value' property='target.DrugProduct.ProductName' action='set' />
<assign value='source.contained.(k5).Medication.code.coding.(1).display.value' property='target.DrugProduct.Generic.OriginalText' action='set' />
<assign value='source.contained.(k5).Medication.code.coding.(1).display.value' property='target.DrugProduct.Generic.Description' action='set' />
<assign value='source.contained.(k5).Medication.code.coding.(1).code.value' property='target.DrugProduct.Generic.Code' action='set' />
</true>
</if>
<code>
<![CDATA[ set i =1 ]]></code>
</true>
</if>
</foreach>
</true>
</if>
<code>
<![CDATA[ set iPrescription = 0]]></code>
</true>
</if>
</foreach>
</true>
</if>
</foreach>
</true>
</if>

</transform>
}

}
