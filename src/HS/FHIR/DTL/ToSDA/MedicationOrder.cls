Class HS.FHIR.DTL.ToSDA.MedicationOrder Extends Ens.DataTransformDTL [ DependsOn = (HS.FHIR.vDSTU2.Model.Resource.MedicationOrder, HS.SDA3.Medication) ]
{

Parameter IGNOREMISSINGSOURCE = 1;

Parameter REPORTERRORS = 1;

Parameter TREATEMPTYREPEATINGFIELDASNULL = 0;

XData DTL [ XMLNamespace = "http://www.intersystems.com/dtl" ]
{
<transform sourceClass='HS.FHIR.vDSTU2.Model.Resource.MedicationOrder' targetClass='HS.SDA3.Medication' create='new' language='objectscript' >
<annotation>This transform uses the reserved DTL input parameter named &#39;aux&#39;.
For this transform, aux is a local array of strings.  The values held in aux were generated by the FHIR to SDA DTL framework prior to calling into this transform.
aux("EncounterNumbers", fhir_resource_id) = SDA EncounterNumber to use for the encounter pointed to by the FHIR resource.</annotation>

<foreach property='source.identifier()' key='k1' >
<if condition='source.identifier.(k1).type.text.value &apos;=""' >
<true>
<if condition='(target.PlacerId = "")&amp;&amp;(source.identifier.(k1).type.text.value = "PlacerId")||((source.identifier.(k1).type.coding.Count()&gt;0)&amp;&amp;(source.identifier.(k1).type.coding.GetAt(1).code.value="PLAC"))' >
<true>
<assign value='source.identifier.(k1).value.value' property='target.PlacerId' action='set' />
<code>
<![CDATA[ set identsUsed(k1) = ""]]></code></true>
<false>
<if condition='(target.FillerId = "")&amp;&amp;(source.identifier.(k1).type.text.value = "FillerId")||((source.identifier.(k1).type.coding.Count()&gt;0)&amp;&amp;(source.identifier.(k1).type.coding.GetAt(1).code.value="PLAC")) ' >
<true>
<assign value='source.identifier.(k1).value.value' property='target.FillerId' action='set' />
<code>
<![CDATA[ set identsUsed(k1) = ""]]></code></true>
<false>
<if condition='(target.ExternalId = "")&amp;&amp;(source.identifier.(k1).type.text.value = "ExternalId") ' >
<true>
<assign value='source.identifier.(k1).value.value' property='target.ExternalId' action='set' />
<code>
<![CDATA[ set identsUsed(k1) = ""]]></code></true>
</if>
</false>
</if>
</false>
</if>
</true>
</if>
</foreach>
<foreach property='source.identifier()' key='k5' >
<if condition='$Data(identsUsed(k5)) = 0' >
<true>
<if condition='target.PlacerId = ""' >
<true>
<assign value='source.identifier.(k5).value.value' property='target.PlacerId' action='set' />
</true>
<false>
<if condition='target.FillerId = "" ' >
<true>
<assign value='source.identifier.(k5).value.value' property='target.FillerId' action='set' />
</true>
<false>
<if condition='target.ExternalId = "" ' >
<true>
<assign value='source.identifier.(k5).value.value' property='target.ExternalId' action='set' />
</true>
</if>
</false>
</if>
</false>
</if>
</true>
</if>
</foreach>

<assign value='##class(HS.FHIR.DTL.Utils).LookupFHIR("ToSDAMedicationOrderStatus",source.status.value)' property='target.Status' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).NormalizeTimeStamp(source.dateWritten.value)' property='target.EnteredOn' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).NormalizeTimeStamp(source.dateEnded.value)' property='target.ToTime' action='set' />

<if condition='$IsObject(source.medicationCodeableConcept)' >
<true>
<assign value='source.medicationCodeableConcept.text.value' property='target.OrderItem.OriginalText' action='set' />
<if condition='source.medicationCodeableConcept.coding.(1) &apos;= ""' >
<true>
<assign value='source.medicationCodeableConcept.coding.(1).display.value' property='target.OrderItem.Description' action='set' />
<assign value='source.medicationCodeableConcept.coding.(1).code.value' property='target.OrderItem.Code' action='set' />
<assign value='source.medicationCodeableConcept.coding.(1).version.value' property='target.OrderItem.CodeSystemVersionId' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).GetCodeForURI(source.medicationCodeableConcept.coding.(1).system.value)' property='target.OrderItem.SDACodingStandard' action='set' />
</true>
</if>
</true>
<false>
<if condition='..StartsWith(source.medicationReference.reference.value,"#")' >
<true>
<foreach property='source.contained()' key='k2' >
<if condition=' ("#"_source.contained.(k2).Medication.id.value = source.medicationReference.reference.value)' >
<true>
<subtransform class='HS.FHIR.DTL.ToSDA.SubTransform.MedicationOrderItem' targetObj='target' sourceObj='source.contained.(k2).Medication' />
</true>
</if>
</foreach>
</true>
</if>
</false>
</if>

<if condition='..StartsWith(source.prescriber.reference.value,"#") ' >
<true>
<foreach property='source.contained()' key='k1' >
<if condition='("#"_source.contained.(k1).Practitioner.id.value = source.prescriber.reference.value)' >
<true>
<subtransform class='HS.FHIR.DTL.ToSDA.SubTransform.Practitioner' targetObj='target.OrderedBy' sourceObj='source.contained.(k1).Practitioner' />
</true>
</if>
</foreach>
</true>
</if>
<if condition='..Piece(source.encounter.reference.value,"Encounter/",2) &apos;= ""' >
<true>
<assign value='$G(aux("EncounterNumbers",..Piece(source.encounter.reference.value,"Encounter/",2)))' property='target.EncounterNumber' action='set' />
</true>
</if>
<assign value='source.note.value' property='target.Comments' action='set' />
<if condition='..StartsWith(source.medicationReference.reference.value,"#")' >
<true>
<foreach property='source.contained()' key='k2' >
<if condition='("#"_source.contained.(k2).Medication.id.value = source.medicationReference.reference.value) ' >
<true>
<subtransform class='HS.FHIR.DTL.ToSDA.SubTransform.MedicationOrderItem' targetObj='target' sourceObj='source.contained.(k2).Medication' />
</true>
</if>
</foreach>
</true>
</if>
<foreach property='source.dosageInstruction()' key='k3' >
<assign value='source.dosageInstruction.(k3).doseQuantity.code.value' property='target.DosageSteps.(k3).DoseUoM.Code' action='set' />
<assign value='source.dosageInstruction.(k3).doseQuantity.unit.value' property='target.DosageSteps.(k3).DoseUoM.Description' action='set' />
<assign value='source.dosageInstruction.(k3).doseQuantity.value.value' property='target.DosageSteps.(k3).DoseQuantity' action='set' />
<assign value='source.dosageInstruction.(k3).text.value' property='target.DosageSteps.(k3).TextInstruction' action='set' />
<if condition='k3=1' >
<true>
<assign value='source.dosageInstruction.(k3).route.text.value' property='target.Route.OriginalText' action='set' />
<if condition="$IsObject(source.dosageInstruction.(k3).route.coding) &amp;&amp; (source.dosageInstruction.(k3).route.coding.Count()&gt;0)">
<true>
<assign value='source.dosageInstruction.(k3).route.coding.(1).display.value' property='target.Route.Description' action='set' />
<assign value='source.dosageInstruction.(k3).route.coding.(1).code.value' property='target.Route.Code' action='set' />
<assign value='source.dosageInstruction.(k3).route.coding.(1).version.value' property='target.Route.CodeSystemVersionId' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).GetCodeForURI(source.dosageInstruction.(k3).route.coding.(1).system.value)' property='target.Route.SDACodingStandard' action='set' />
</true>
</if>
</true>
</if>
</foreach>
<assign value='source.dispenseRequest.numberOfRepeatsAllowed.value' property='target.NumberOfRefills' action='set' />
<assign value='source.dispenseRequest.quantity.value.value' property='target.OrderQuantity' action='set' />
<assign value='source.dispenseRequest.quantity.unit.value' property='target.RateUnits.Description' action='set' />
<assign value='source.dispenseRequest.quantity.code.value' property='target.RateUnits.Code' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).GetCodeForURI(source.dispenseRequest.quantity.system.value)' property='target.RateUnits.SDACodingStandard' action='set' />

<foreach property='source.contained()' key='k7' >
<if condition='source.contained.(k7).MedicationDispense.id.value &apos;= "" ' >
<true>
<code>
<![CDATA[ set aux("FromMedicationOrder") = 1 ]]></code>
<subtransform class='HS.FHIR.DTL.ToSDA.MedicationDispense' targetObj='target' sourceObj='source.contained.(k7).MedicationDispense' aux='.aux' />
<code>
<![CDATA[ kill aux("FromMedicationOrder") ]]></code></true>
</if>
</foreach>

<code>
<![CDATA[ set aux("MedicationAdministrationPosition") = 1]]></code>
<foreach property='source.contained()' key='k6' >
<if condition='source.contained.(k6).MedicationAdministration.id.value &apos;= "" ' >
<true>
<subtransform class='HS.FHIR.DTL.ToSDA.MedicationAdministration' targetObj='target' sourceObj='source.contained.(k6).MedicationAdministration' aux='.aux' />
<code>
<![CDATA[ set aux("MedicationAdministrationPosition") = aux("MedicationAdministrationPosition") + 1 ]]></code></true>
</if>
</foreach>

</transform>
}

}
