Class HS.FHIR.DTL.FromSDA.MedicationDispense Extends Ens.DataTransformDTL [ DependsOn = (HS.SDA3.Medication, HS.FHIR.vDSTU2.Model.Resource.MedicationDispense) ]
{

Parameter IGNOREMISSINGSOURCE = 1;

Parameter REPORTERRORS = 1;

Parameter TREATEMPTYREPEATINGFIELDASNULL = 0;

XData DTL [ XMLNamespace = "http://www.intersystems.com/dtl" ]
{
<transform sourceClass='HS.SDA3.Medication' targetClass='HS.FHIR.vDSTU2.Model.Resource.MedicationDispense' create='new' language='objectscript' >
<annotation>This transform uses the reserved DTL input parameter named &#39;aux&#39;.
For this transform, aux is a local array of strings.  The values held in aux were generated by the SDA to FHIR DTL framework prior to calling into this transform.
aux("ResourceId"): FHIR resource id to assign to the resource being created by this transform.
aux("PatientResourceId"): FHIR resource id for the patient represented by the Patient object in the SDA Container being transformed.
aux("MedicationResourceId") = FHIR resource id to assign to the Medication resource referred to by the MedicationDispense resource being created.
aux("MedicationOrderResourceId") = FHIR resource id to assign to the MedicationOrder resource referred to by the MedicationDispense resource being created.</annotation>
<assign value='$G(aux("ResourceId"))' property='target.id.value' action='set' />
<if condition='source.ExternalId &apos;= ""' >
<true>
<assign value='"official"' property='target.identifier.use.value' action='set' />
<assign value='"ExternalId"' property='target.identifier.type.text.value' action='set' />
<assign value='source.ExternalId' property='target.identifier.value.value' action='set' />
</true>
</if>
<assign value='##class(HS.FHIR.DTL.Utils).LookupFHIR("FromSDAMedicationDispenseStatus",source.Status)' property='target.status.value' action='set' />
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.PatientReference' targetObj='target.patient' sourceObj='target' aux='.aux' />
<assign value='"MedicationOrder/"_$G(aux("MedicationOrderResourceId"))' property='target.authorizingPrescription.(1).reference.value' action='set' />
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.CodeTableTranslated' sourceObj='source.DrugProduct.Type' targetObj='target.type' />
<assign value='"Medication/"_$G(aux("MedicationResourceId"))' property='target.medicationReference.reference.value' action='set' />
<assign value='source.Comments' property='target.note.value' action='set' />
<if condition='source.DosageSteps.Count() &gt; 0'>
<true>
<foreach property='source.DosageSteps()' key='k1' >
<assign value='source.DosageSteps.(k1).TextInstruction' property='target.dosageInstruction.(k1).text.value' action='set' />
<if condition='(source.DosageSteps.(k1).FromTime &apos;= "") || (source.DosageSteps.(k1).ToTime &apos;="") '>
<true>
<assign value='##class(HS.FHIR.DTL.Utils).FHIRDateTime(source.DosageSteps.(k1).FromTime)' property='target.dosageInstruction.(k1).timing.repeat.boundsPeriod.start.value' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).FHIRDateTime(source.DosageSteps.(k1).ToTime)' property='target.dosageInstruction.(k1).timing.repeat.boundsPeriod.end.value' action='set' />
</true>
</if>
<code>
<![CDATA[ set frequencyData = ##class(HS.FHIR.DTL.Utils).GetFrequency(source.DosageSteps.GetAt(k1).Frequency.Code,source.DosageSteps.GetAt(k1).Frequency.Description)]]></code>
<if condition='frequencyData &apos;= ""'>
<true>
<if condition='..Piece(frequencyData,"|",1) &apos;= ""' >
<true>
<assign value='..Piece(frequencyData,"|",1)' property='target.dosageInstruction.(k1).timing.code.coding.(1).code.value' action='set' />
<assign value='..Piece(frequencyData,"|",2)' property='target.dosageInstruction.(k1).timing.code.coding.(1).display.value' action='set' />
<assign value='..Piece(frequencyData,"|",3)' property='target.dosageInstruction.(k1).timing.code.coding.(1).system.value' action='set' />
<assign value='..Piece(frequencyData,"|",2)' property='target.dosageInstruction.(k1).timing.code.text.value' action='set' />
</true>
</if>
<if condition='..Piece(frequencyData,"|",4) &apos;= ""' >
<true>
<assign value='..Piece(frequencyData,"|",4)' property='target.dosageInstruction.(k1).timing.repeat.frequency.value' action='set' />
<assign value='..Piece(frequencyData,"|",5)' property='target.dosageInstruction.(k1).timing.repeat.period.value' action='set' />
<assign value='..Piece(frequencyData,"|",6)' property='target.dosageInstruction.(k1).timing.repeat.periodUnits.value' action='set' />
<assign value='..Piece(frequencyData,"|",7)' property='target.dosageInstruction.(k1).timing.repeat.when.value' action='set' />
</true>
</if>
</true>
</if>
<if condition='..ToUpper(source.DosageSteps.GetAt(k1).Frequency.Code) = "PRN"' >
<true>
<assign value='"1"' property='target.dosageInstruction.(k1).asNeededBoolean.value' action='set' />
</true>
</if>
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.CodeTableTranslated' sourceObj='source.Route' targetObj='target.dosageInstruction.(k1).route' />
<assign value='source.DosageSteps.(k1).DoseUoM.Code' property='target.dosageInstruction.(k1).doseQuantity.code.value' action='set' />
<assign value='source.DosageSteps.(k1).DoseUoM.Description' property='target.dosageInstruction.(k1).doseQuantity.unit.value' action='set' />
<assign value='source.DosageSteps.(k1).DoseQuantity' property='target.dosageInstruction.(k1).doseQuantity.value.value' action='set' />
</foreach>
</true>
<false>
<assign value='source.TextInstruction' property='target.dosageInstruction.(1).text.value' action='set' />
<if condition='(source.FromTime &apos;= "") || (source.ToTime &apos;="") '>
<true>
<assign value='##class(HS.FHIR.DTL.Utils).FHIRDateTime(source.FromTime)' property='target.dosageInstruction.(1).timing.repeat.boundsPeriod.start.value' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).FHIRDateTime(source.ToTime)' property='target.dosageInstruction.(1).timing.repeat.boundsPeriod.end.value' action='set' />
</true>
</if>
<code>
<![CDATA[ set frequencyData = ##class(HS.FHIR.DTL.Utils).GetFrequency(source.Frequency.Code,source.Frequency.Description)]]></code>
<if condition='frequencyData &apos;= ""'>
<true>
<if condition='..Piece(frequencyData,"|",1) &apos;= ""' >
<true>
<assign value='..Piece(frequencyData,"|",1)' property='target.dosageInstruction.(1).timing.code.coding.(1).code.value' action='set' />
<assign value='..Piece(frequencyData,"|",2)' property='target.dosageInstruction.(1).timing.code.coding.(1).display.value' action='set' />
<assign value='..Piece(frequencyData,"|",3)' property='target.dosageInstruction.(1).timing.code.coding.(1).system.value' action='set' />
<assign value='..Piece(frequencyData,"|",2)' property='target.dosageInstruction.(1).timing.code.text.value' action='set' />
</true>
</if>
<if condition='..Piece(frequencyData,"|",4) &apos;= ""' >
<true>
<assign value='..Piece(frequencyData,"|",4)' property='target.dosageInstruction.(1).timing.repeat.frequency.value' action='set' />
<assign value='..Piece(frequencyData,"|",5)' property='target.dosageInstruction.(1).timing.repeat.period.value' action='set' />
<assign value='..Piece(frequencyData,"|",6)' property='target.dosageInstruction.(1).timing.repeat.periodUnits.value' action='set' />
<assign value='..Piece(frequencyData,"|",7)' property='target.dosageInstruction.(1).timing.repeat.when.value' action='set' />
</true>
</if>
</true>
</if>
<if condition='..ToUpper(source.Frequency.Code) = "PRN"' >
<true>
<assign value='"1"' property='target.dosageInstruction.(1).asNeededBoolean.value' action='set' />
</true>
</if>
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.CodeTableTranslated' sourceObj='source.Route' targetObj='target.dosageInstruction.(1).route' />
<assign value='source.DoseUoM.Code' property='target.dosageInstruction.(1).doseQuantity.code.value' action='set' />
<assign value='source.DoseUoM.Description' property='target.dosageInstruction.(1).doseQuantity.unit.value' action='set' />
<assign value='source.DoseQuantity' property='target.dosageInstruction.(1).doseQuantity.value.value' action='set' />
</false>
</if>
</transform>
}

}
