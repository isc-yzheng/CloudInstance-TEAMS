Class HS.FHIR.DTL.FromSDA.RadOrderDiagnosticReport Extends Ens.DataTransformDTL [ DependsOn = (HS.SDA3.RadOrder, HS.FHIR.vDSTU2.Model.Resource.DiagnosticReport) ]
{

Parameter IGNOREMISSINGSOURCE = 1;

Parameter REPORTERRORS = 1;

Parameter TREATEMPTYREPEATINGFIELDASNULL = 0;

XData DTL [ XMLNamespace = "http://www.intersystems.com/dtl" ]
{
<transform sourceClass='HS.SDA3.RadOrder' targetClass='HS.FHIR.vDSTU2.Model.Resource.DiagnosticReport' create='new' language='objectscript' >
<annotation>This transform uses the reserved DTL input parameter named &#39;aux&#39;.
For this transform, aux is a local array of strings.  The values held in aux were generated by the SDA to FHIR DTL framework prior to calling into this transform.
aux("ResourceId"): FHIR resource id to assign to the resource being created by this transform.
aux("PatientResourceId"): FHIR resource id for the patient represented by the Patient object in the SDA Container being transformed.
aux("EncounterResourceIds", sda_encounter_number) = FHIR resource id for the Encounters from the SDA Container.
aux("OrderResourceId"): FHIR resource id to be used for the FHIR DiagnosticOrder created from the SDA LabOrder, RadOrder or OtherOrder.
aux("ResultResourceId"): FHIR resource id to be used for the FHIR Observation resource for the SDA Result (not ResultItem).
aux("ResultItemResourceIds", n): FHIR resource ids to be used for the FHIR Observation resources for the SDA LabResultItems.</annotation>
<assign value='$G(aux("ResourceId"))' property='target.id.value' action='set' />
<code>
<![CDATA[ set iIdentifier=1]]></code>
<if condition='source.ExternalId &apos;= ""' >
<true>
<assign value='"official"' property='target.identifier.(iIdentifier).use.value' action='set' />
<assign value='"ExternalId"' property='target.identifier.(iIdentifier).type.text.value' action='set' />
<assign value='source.ExternalId' property='target.identifier.(iIdentifier).value.value' action='set' />
<code>
<![CDATA[ set iIdentifier=iIdentifier + 1]]></code>
</true>
</if>
<if condition='source.PlacerId &apos;=""' >
<true>
<assign value='"official"' property='target.identifier.(iIdentifier).use.value' action='set' />
<assign value='"http://hl7.org/fhir/identifier-type"' property='target.identifier.(iIdentifier).type.coding.(1).system.value' action='set' />
<assign value='"PLAC"' property='target.identifier.(iIdentifier).type.coding.(1).code.value' action='set' />
<assign value='"Placer Identifier"' property='target.identifier.(iIdentifier).type.coding.(1).display.value' action='set' />
<assign value='source.PlacerId' property='target.identifier.(iIdentifier).value.value' action='set' />
<assign value='"PlacerId"' property='target.identifier.(iIdentifier).type.text.value' action='set' />
<code>
<![CDATA[ set iIdentifier=iIdentifier + 1]]></code>
</true>
</if>
<if condition='source.FillerId &apos;= ""' >
<true>
<assign value='"official"' property='target.identifier.(iIdentifier).use.value' action='set' />
<assign value='"http://hl7.org/fhir/identifier-type"' property='target.identifier.(iIdentifier).type.coding.(1).system.value' action='set' />
<assign value='"FILL"' property='target.identifier.(iIdentifier).type.coding.(1).code.value' action='set' />
<assign value='"Filler Identifier"' property='target.identifier.(iIdentifier).type.coding.(1).display.value' action='set' />
<assign value='source.FillerId' property='target.identifier.(iIdentifier).value.value' action='set' />
<assign value='"FillerId"' property='target.identifier.(iIdentifier).type.text.value' action='set' />
<code>
<![CDATA[ set iIdentifier=iIdentifier + 1]]></code>
</true>
</if>
<if condition='source.Result.ResultStatus &apos;= ""'>
<true>
<assign value='##class(HS.FHIR.DTL.Utils).LookupFHIR("FromSDARadOrderDiagnosticReportStatus",source.Result.ResultStatus,"final",3)' property='target.status.value' action='set' />
</true>
<false>
<if condition='(source.Result.ResultItems.Count()&gt;0)||(source.Result.ResultText&apos;="")||($IsObject(source.Result.Stream))' >
<true>
<assign value='"final"' property='target.status.value' action='set' />
</true>
<false>
<assign value='"registered"' property='target.status.value' action='set' />
</false>
</if>
</false>
</if>
<assign value='"Radiology"' property='target.category.text.value' action='set' />
<assign value='"RAD"' property='target.category.coding.(1).code.value' action='set' />
<assign value='"http://hl7.org/fhir/v2/0074"' property='target.category.coding.(1).system.value' action='set' />
<assign value='"Radiology"' property='target.category.coding.(1).display.value' action='set' />
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.CodeTableTranslated' targetObj='target.code' sourceObj='source.OrderItem' />
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.PatientReference' targetObj='target.subject' sourceObj='target' aux='.aux' />
<if condition='(source.EncounterNumber &apos;= "") &amp;&amp; ($G(aux("EncounterResourceIds",source.EncounterNumber)) &apos;= "")' >
<true>
<assign value='"Encounter/"_aux("EncounterResourceIds",source.EncounterNumber)' property='target.encounter.reference.value' action='set' />
<assign value='source.EncounterNumber' property='target.encounter.display.value' action='set' />
</true>
</if>
<assign value='##class(HS.FHIR.DTL.Utils).FHIRDateTime(source.EnteredOn)' property='target.effectiveDateTime.value' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).FHIRInstant(source.EnteredOn)' property='target.issued.value' action='set' />
<code>
<![CDATA[ set iContained = 1]]></code>
<if condition='(source.Result.ResultType = "IM") || ((source.Result.ResultType = "")&amp;&amp;(source.Result.ResultText &apos;= "")) ' >
<true>
<assign value='##class(HS.FHIR.DTL.Utils).FHIRDateTime(source.FromTime)' property='target.effectivePeriod.start.value' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).FHIRDateTime(source.ToTime)' property='target.effectivePeriod.end.value' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).FHIRInstant(source.Result.ResultTime)' property='target.issued.value' action='set' />
<assign value='"Observation/"_$G(aux("ResultResourceId"))' property='target.result.(1).reference.value' action='set' />
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.ResultRadObservation' targetObj='target.contained.(iContained).Observation' sourceObj='source.Result' />
<assign value='$G(aux("ResultResourceId"))' property='target.contained.(iContained).Observation.id.value' action='set' />
<code>
<![CDATA[ set iContainedObservation = iContained
 set iContained = iContained + 1
 ]]></code>
</true>
</if>
<if condition='target.issued.value = ""' >
<true>
<assign value='##class(HS.FHIR.DTL.Utils).FHIRInstant($ZDateTime($HoroLog,3))' property='target.issued.value' action='set' />
</true>
</if>
<if condition='##class(HS.FHIR.DTL.Utils).CPIsDefined(source,"OrderedBy")' >
<true>
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.CareProvider' targetObj='target.contained.(iContained).Practitioner' sourceObj='source.OrderedBy' />
<code>
<![CDATA[ set iContained = iContained + 1]]></code>
</true>
</if>
<if condition='##class(HS.FHIR.DTL.Utils).CPIsDefined(source,"VerifiedBy")' >
<true>
<assign value='"#"_source.VerifiedBy.InternalReference' property='target.performer.reference.value' action='set' />
<assign value='source.VerifiedBy.Name.GivenName_" "_source.VerifiedBy.Name.FamilyName' property='target.performer.display.value' action='set' />
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.CareProvider' targetObj='target.contained.(iContained).Practitioner' sourceObj='source.VerifiedBy' />
<code>
<![CDATA[ set iContained = iContained + 1]]></code>
</true>
<false>
<assign value='"unknown"' property='target.performer.display.value' action='set' />
</false>
</if>
<assign value='source.ReasonForStudy.Description' property='target.request.(1).display.value' action='set' />
<assign value='"#"_$G(aux("OrderResourceId"))' property='target.request.(1).reference.value' action='set' />
<subtransform class='HS.FHIR.DTL.FromSDA.RadOrderDiagnosticOrder' targetObj='target.contained.(iContained).DiagnosticOrder' sourceObj='source' aux='.aux' />
<assign value='$G(aux("OrderResourceId"))' property='target.contained.(iContained).DiagnosticOrder.id.value' action='set' />
<code>
<![CDATA[ set iContained = iContained + 1]]></code>
<if condition='source.Specimen &apos;= ""' >
<true>
<assign value='source.Specimen' property='target.specimen.(1).display.value' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).FHIRDateTime(source.SpecimenReceivedTime)' property='target.contained.(iContained).Specimen.receivedTime.value' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).FHIRDateTime(source.SpecimenCollectedTime)' property='target.contained.(iContained).Specimen.collection.collectedDateTime.value' action='set' />
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.PatientReference' targetObj='target.contained.(iContained).Specimen.subject' sourceObj='target' aux='.aux' />
<assign value='##class(HS.FHIR.DTL.Utils).CreateUUID()' property='target.contained.(iContained).Specimen.id.value' action='set' />
<assign value='"#"_target.contained.(iContained).Specimen.id.value' property='target.specimen.(1).reference.value' action='set' />
<code>
<![CDATA[ set iContained = iContained + 1]]></code>
</true>
</if>
<assign value='source.Condition' property='target.conclusion.value' action='set' />
<code>
<![CDATA[ set iContainedPerformer = 1]]></code>
<if condition='##class(HS.FHIR.DTL.Utils).OrgIsDefined(source.Result, "EnteredAt")' >
<true>
<assign value='source.Result.EnteredAt.Description' property='target.contained.(iContainedObservation).Observation.performer.(iContainedPerformer).display.value' action='set' />
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.Address' targetObj='target.contained.(iContained).Organization.address.(iContainedPerformer)' sourceObj='source.Result.EnteredAt.Address' disabled='1' />
<assign value='##class(HS.FHIR.DTL.Utils).CreateUUID()' property='target.contained.(iContained).Organization.id.value' action='set' />
<assign value='"#"_target.contained.(iContained).Organization.id.value' property='target.contained.(iContainedObservation).Observation.performer.(iContainedPerformer).reference.value' action='set' />
<assign value='source.Result.EnteredAt.Description' property='target.contained.(iContained).Organization.name.value' action='set' />
<assign value='source.Result.EnteredAt.Code' property='target.contained.(iContained).Organization.name.id' action='set' />
<assign value='"official"' property='target.contained.(iContained).Organization.identifier.(1).use.value' action='set' />
<code>
<![CDATA[ set iTelecom = 1]]></code>
<if condition='source.Result.EnteredAt.ContactInfo.HomePhoneNumber &apos;= ""' >
<true>
<assign value='"phone"' property='target.contained.(iContained).Organization.telecom.(iTelecom).system.value' action='set' />
<assign value='"home"' property='target.contained.(iContained).Organization.telecom.(iTelecom).use.value' action='set' />
<assign value='source.Result.EnteredAt.ContactInfo.HomePhoneNumber' property='target.contained.(iContained).Organization.telecom.(iTelecom).value.value' action='set' />
<code>
<![CDATA[ set iTelecom = iTelecom + 1]]></code>
</true>
</if>
<if condition='source.Result.EnteredAt.ContactInfo.WorkPhoneNumber &apos;= ""' >
<true>
<assign value='"phone"' property='target.contained.(iContained).Organization.telecom.(iTelecom).system.value' action='set' />
<assign value='"work"' property='target.contained.(iContained).Organization.telecom.(iTelecom).use.value' action='set' />
<assign value='source.Result.EnteredAt.ContactInfo.WorkPhoneNumber' property='target.contained.(iContained).Organization.telecom.(iTelecom).value.value' action='set' />
<code>
<![CDATA[ set iTelecom = iTelecom + 1]]></code>
</true>
</if>
<if condition='source.Result.EnteredAt.ContactInfo.MobilePhoneNumber &apos;= ""' >
<true>
<assign value='"phone"' property='target.contained.(iContained).Organization.telecom.(iTelecom).system.value' action='set' />
<assign value='"mobile"' property='target.contained.(iContained).Organization.telecom.(iTelecom).use.value' action='set' />
<assign value='source.Result.EnteredAt.ContactInfo.MobilePhoneNumber' property='target.contained.(iContained).Organization.telecom.(iTelecom).value.value' action='set' />
<code>
<![CDATA[ set iTelecom = iTelecom + 1]]></code>
</true>
</if>
<if condition='source.Result.EnteredAt.ContactInfo.EmailAddress &apos;= ""' >
<true>
<assign value='"email"' property='target.contained.(iContained).Organization.telecom.(iTelecom).system.value' action='set' />
<assign value='source.Result.EnteredAt.ContactInfo.EmailAddress' property='target.contained.(iContained).Organization.telecom.(iTelecom).value.value' action='set' />
<code>
<![CDATA[ set iTelecom = iTelecom + 1]]></code>
</true>
</if>
<code>
<![CDATA[ set iContained = iContained + 1
 set iContainedPerformer = iContainedPerformer + 1]]></code>
</true>
</if>
<if condition='##class(HS.FHIR.DTL.Utils).OrgIsDefined(source.Result,"PerformedAt")' >
<true>
<assign value='source.Result.PerformedAt.Description' property='target.contained.(iContainedObservation).Observation.performer.(iContainedPerformer).display.value' action='set' />
<if condition='$IsObject(source.Result.PerformedAt.Address)' >
<true>
<subtransform class='HS.FHIR.DTL.FromSDA.SubTransform.Address' targetObj='target.contained.(iContained).Organization.address.(1)' sourceObj='source.Result.PerformedAt.Address' disabled='1' />
</true>
</if>
<assign value='source.Result.PerformedAt.Code' property='target.contained.(iContained).Organization.name.id' action='set' />
<assign value='source.Result.PerformedAt.Description' property='target.contained.(iContained).Organization.name.value' action='set' />
<assign value='##class(HS.FHIR.DTL.Utils).CreateUUID()' property='target.contained.(iContained).Organization.id.value' action='set' />
<assign value='"#"_target.contained.(iContained).Organization.id.value' property='target.contained.(iContainedObservation).Observation.performer.(iContainedPerformer).reference.value' action='set' />
<code>
<![CDATA[ set iTelecom = 1]]></code>
<if condition='source.Result.PerformedAt.ContactInfo.HomePhoneNumber &apos;= ""' >
<true>
<assign value='"phone"' property='target.contained.(iContained).Organization.telecom.(iTelecom).system.value' action='set' />
<assign value='"home"' property='target.contained.(iContained).Organization.telecom.(iTelecom).use.value' action='set' />
<assign value='source.Result.PerformedAt.ContactInfo.HomePhoneNumber' property='target.contained.(iContained).Organization.telecom.(iTelecom).value.value' action='set' />
<code>
<![CDATA[ set iTelecom = iTelecom + 1]]></code>
</true>
</if>
<if condition='source.Result.PerformedAt.ContactInfo.WorkPhoneNumber &apos;= ""' >
<true>
<assign value='"phone"' property='target.contained.(iContained).Organization.telecom.(iTelecom).system.value' action='set' />
<assign value='"work"' property='target.contained.(iContained).Organization.telecom.(iTelecom).use.value' action='set' />
<assign value='source.Result.PerformedAt.ContactInfo.WorkPhoneNumber' property='target.contained.(iContained).Organization.telecom.(iTelecom).value.value' action='set' />
<code>
<![CDATA[ set iTelecom = iTelecom + 1]]></code>
</true>
</if>
<if condition='source.Result.PerformedAt.ContactInfo.MobilePhoneNumber &apos;= ""' >
<true>
<assign value='"phone"' property='target.contained.(iContained).Organization.telecom.(iTelecom).system.value' action='set' />
<assign value='"mobile"' property='target.contained.(iContained).Organization.telecom.(iTelecom).use.value' action='set' />
<assign value='source.Result.PerformedAt.ContactInfo.MobilePhoneNumber' property='target.contained.(iContained).Organization.telecom.(iTelecom).value.value' action='set' />
<code>
<![CDATA[ set iTelecom = iTelecom + 1]]></code>
</true>
</if>
<if condition='source.Result.PerformedAt.ContactInfo.EmailAddress &apos;= ""' >
<true>
<assign value='"email"' property='target.contained.(iContained).Organization.telecom.(iTelecom).system.value' action='set' />
<assign value='source.Result.PerformedAt.ContactInfo.EmailAddress' property='target.contained.(iContained).Organization.telecom.(iTelecom).value.value' action='set' />
<code>
<![CDATA[ set iTelecom = iTelecom + 1]]></code>
</true>
</if>
<code>
<![CDATA[ set iContained = iContained + 1]]></code>
</true>
</if>
</transform>
}

}
